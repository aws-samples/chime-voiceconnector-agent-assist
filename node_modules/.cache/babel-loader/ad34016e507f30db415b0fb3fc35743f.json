{"ast":null,"code":"var AWS = require('../core');\n\nvar inherit = AWS.util.inherit;\n/**\n * @api private\n */\n\nvar expiresHeader = 'presigned-expires';\n/**\n * @api private\n */\n\nfunction signedUrlBuilder(request) {\n  var expires = request.httpRequest.headers[expiresHeader];\n  var signerClass = request.service.getSignerClass(request);\n  delete request.httpRequest.headers['User-Agent'];\n  delete request.httpRequest.headers['X-Amz-User-Agent'];\n\n  if (signerClass === AWS.Signers.V4) {\n    if (expires > 604800) {\n      // one week expiry is invalid\n      var message = 'Presigning does not support expiry time greater ' + 'than a week with SigV4 signing.';\n      throw AWS.util.error(new Error(), {\n        code: 'InvalidExpiryTime',\n        message: message,\n        retryable: false\n      });\n    }\n\n    request.httpRequest.headers[expiresHeader] = expires;\n  } else if (signerClass === AWS.Signers.S3) {\n    var now = request.service ? request.service.getSkewCorrectedDate() : AWS.util.date.getDate();\n    request.httpRequest.headers[expiresHeader] = parseInt(AWS.util.date.unixTimestamp(now) + expires, 10).toString();\n  } else {\n    throw AWS.util.error(new Error(), {\n      message: 'Presigning only supports S3 or SigV4 signing.',\n      code: 'UnsupportedSigner',\n      retryable: false\n    });\n  }\n}\n/**\n * @api private\n */\n\n\nfunction signedUrlSigner(request) {\n  var endpoint = request.httpRequest.endpoint;\n  var parsedUrl = AWS.util.urlParse(request.httpRequest.path);\n  var queryParams = {};\n\n  if (parsedUrl.search) {\n    queryParams = AWS.util.queryStringParse(parsedUrl.search.substr(1));\n  }\n\n  var auth = request.httpRequest.headers['Authorization'].split(' ');\n\n  if (auth[0] === 'AWS') {\n    auth = auth[1].split(':');\n    queryParams['AWSAccessKeyId'] = auth[0];\n    queryParams['Signature'] = auth[1];\n    AWS.util.each(request.httpRequest.headers, function (key, value) {\n      if (key === expiresHeader) key = 'Expires';\n\n      if (key.indexOf('x-amz-meta-') === 0) {\n        // Delete existing, potentially not normalized key\n        delete queryParams[key];\n        key = key.toLowerCase();\n      }\n\n      queryParams[key] = value;\n    });\n    delete request.httpRequest.headers[expiresHeader];\n    delete queryParams['Authorization'];\n    delete queryParams['Host'];\n  } else if (auth[0] === 'AWS4-HMAC-SHA256') {\n    // SigV4 signing\n    auth.shift();\n    var rest = auth.join(' ');\n    var signature = rest.match(/Signature=(.*?)(?:,|\\s|\\r?\\n|$)/)[1];\n    queryParams['X-Amz-Signature'] = signature;\n    delete queryParams['Expires'];\n  } // build URL\n\n\n  endpoint.pathname = parsedUrl.pathname;\n  endpoint.search = AWS.util.queryParamsToString(queryParams);\n}\n/**\n * @api private\n */\n\n\nAWS.Signers.Presign = inherit({\n  /**\n   * @api private\n   */\n  sign: function sign(request, expireTime, callback) {\n    request.httpRequest.headers[expiresHeader] = expireTime || 3600;\n    request.on('build', signedUrlBuilder);\n    request.on('sign', signedUrlSigner);\n    request.removeListener('afterBuild', AWS.EventListeners.Core.SET_CONTENT_LENGTH);\n    request.removeListener('afterBuild', AWS.EventListeners.Core.COMPUTE_SHA256);\n    request.emit('beforePresign', [request]);\n\n    if (callback) {\n      request.build(function () {\n        if (this.response.error) callback(this.response.error);else {\n          callback(null, AWS.util.urlFormat(request.httpRequest.endpoint));\n        }\n      });\n    } else {\n      request.build();\n      if (request.response.error) throw request.response.error;\n      return AWS.util.urlFormat(request.httpRequest.endpoint);\n    }\n  }\n});\n/**\n * @api private\n */\n\nmodule.exports = AWS.Signers.Presign;","map":{"version":3,"sources":["/home/ec2-user/chime-voiceconnector-agent-assist/node_modules/@aws-amplify/core/node_modules/aws-sdk/lib/signers/presign.js"],"names":["AWS","require","inherit","util","expiresHeader","signedUrlBuilder","request","expires","httpRequest","headers","signerClass","service","getSignerClass","Signers","V4","message","error","Error","code","retryable","S3","now","getSkewCorrectedDate","date","getDate","parseInt","unixTimestamp","toString","signedUrlSigner","endpoint","parsedUrl","urlParse","path","queryParams","search","queryStringParse","substr","auth","split","each","key","value","indexOf","toLowerCase","shift","rest","join","signature","match","pathname","queryParamsToString","Presign","sign","expireTime","callback","on","removeListener","EventListeners","Core","SET_CONTENT_LENGTH","COMPUTE_SHA256","emit","build","response","urlFormat","module","exports"],"mappings":"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","sourcesContent":["var AWS = require('../core');\nvar inherit = AWS.util.inherit;\n\n/**\n * @api private\n */\nvar expiresHeader = 'presigned-expires';\n\n/**\n * @api private\n */\nfunction signedUrlBuilder(request) {\n  var expires = request.httpRequest.headers[expiresHeader];\n  var signerClass = request.service.getSignerClass(request);\n\n  delete request.httpRequest.headers['User-Agent'];\n  delete request.httpRequest.headers['X-Amz-User-Agent'];\n\n  if (signerClass === AWS.Signers.V4) {\n    if (expires > 604800) { // one week expiry is invalid\n      var message = 'Presigning does not support expiry time greater ' +\n                    'than a week with SigV4 signing.';\n      throw AWS.util.error(new Error(), {\n        code: 'InvalidExpiryTime', message: message, retryable: false\n      });\n    }\n    request.httpRequest.headers[expiresHeader] = expires;\n  } else if (signerClass === AWS.Signers.S3) {\n    var now = request.service ? request.service.getSkewCorrectedDate() : AWS.util.date.getDate();\n    request.httpRequest.headers[expiresHeader] = parseInt(\n      AWS.util.date.unixTimestamp(now) + expires, 10).toString();\n  } else {\n    throw AWS.util.error(new Error(), {\n      message: 'Presigning only supports S3 or SigV4 signing.',\n      code: 'UnsupportedSigner', retryable: false\n    });\n  }\n}\n\n/**\n * @api private\n */\nfunction signedUrlSigner(request) {\n  var endpoint = request.httpRequest.endpoint;\n  var parsedUrl = AWS.util.urlParse(request.httpRequest.path);\n  var queryParams = {};\n\n  if (parsedUrl.search) {\n    queryParams = AWS.util.queryStringParse(parsedUrl.search.substr(1));\n  }\n\n  var auth = request.httpRequest.headers['Authorization'].split(' ');\n  if (auth[0] === 'AWS') {\n    auth = auth[1].split(':');\n    queryParams['AWSAccessKeyId'] = auth[0];\n    queryParams['Signature'] = auth[1];\n\n    AWS.util.each(request.httpRequest.headers, function (key, value) {\n      if (key === expiresHeader) key = 'Expires';\n      if (key.indexOf('x-amz-meta-') === 0) {\n        // Delete existing, potentially not normalized key\n        delete queryParams[key];\n        key = key.toLowerCase();\n      }\n      queryParams[key] = value;\n    });\n    delete request.httpRequest.headers[expiresHeader];\n    delete queryParams['Authorization'];\n    delete queryParams['Host'];\n  } else if (auth[0] === 'AWS4-HMAC-SHA256') { // SigV4 signing\n    auth.shift();\n    var rest = auth.join(' ');\n    var signature = rest.match(/Signature=(.*?)(?:,|\\s|\\r?\\n|$)/)[1];\n    queryParams['X-Amz-Signature'] = signature;\n    delete queryParams['Expires'];\n  }\n\n  // build URL\n  endpoint.pathname = parsedUrl.pathname;\n  endpoint.search = AWS.util.queryParamsToString(queryParams);\n}\n\n/**\n * @api private\n */\nAWS.Signers.Presign = inherit({\n  /**\n   * @api private\n   */\n  sign: function sign(request, expireTime, callback) {\n    request.httpRequest.headers[expiresHeader] = expireTime || 3600;\n    request.on('build', signedUrlBuilder);\n    request.on('sign', signedUrlSigner);\n    request.removeListener('afterBuild',\n      AWS.EventListeners.Core.SET_CONTENT_LENGTH);\n    request.removeListener('afterBuild',\n      AWS.EventListeners.Core.COMPUTE_SHA256);\n\n    request.emit('beforePresign', [request]);\n\n    if (callback) {\n      request.build(function() {\n        if (this.response.error) callback(this.response.error);\n        else {\n          callback(null, AWS.util.urlFormat(request.httpRequest.endpoint));\n        }\n      });\n    } else {\n      request.build();\n      if (request.response.error) throw request.response.error;\n      return AWS.util.urlFormat(request.httpRequest.endpoint);\n    }\n  }\n});\n\n/**\n * @api private\n */\nmodule.exports = AWS.Signers.Presign;\n"]},"metadata":{},"sourceType":"script"}