{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function sent() {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nimport { Mutex } from '@aws-amplify/core';\nimport * as PushStream from 'zen-push';\nimport { ModelPredicateCreator } from '../predicates';\nimport { OpType, QueryOne } from '../types';\nimport { isModelConstructor, STORAGE, validatePredicate } from '../util';\nimport getDefaultAdapter from './adapter/getDefaultAdapter';\n\nvar Storage =\n/** @class */\nfunction () {\n  function Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n    this.schema = schema;\n    this.namespaceResolver = namespaceResolver;\n    this.getModelConstructorByModelName = getModelConstructorByModelName;\n    this.modelInstanceCreator = modelInstanceCreator;\n    this.adapter = adapter;\n    this.adapter = getDefaultAdapter();\n    this.pushStream = new PushStream();\n  }\n\n  Storage.getNamespace = function () {\n    var namespace = {\n      name: STORAGE,\n      relationships: {},\n      enums: {},\n      models: {},\n      nonModels: {}\n    };\n    return namespace;\n  };\n\n  Storage.prototype.init = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var resolve, reject;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (this.initialized !== undefined) {\n              return [2\n              /*return*/\n              ];\n            }\n\n            this.initialized = new Promise(function (res, rej) {\n              resolve = res;\n              reject = rej;\n            });\n            this.adapter.setUp(this.schema, this.namespaceResolver, this.modelInstanceCreator, this.getModelConstructorByModelName).then(resolve, reject);\n            return [4\n            /*yield*/\n            , this.initialized];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  Storage.prototype.save = function (model, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      var result;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.init()];\n\n          case 1:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , this.adapter.save(model, condition)];\n\n          case 2:\n            result = _a.sent();\n            result.forEach(function (r) {\n              var element = r[0],\n                  opType = r[1];\n              var modelConstructor = Object.getPrototypeOf(element).constructor;\n\n              _this.pushStream.next({\n                model: modelConstructor,\n                opType: opType,\n                element: element,\n                mutator: mutator,\n                condition: ModelPredicateCreator.getPredicates(condition, false)\n              });\n            });\n            return [2\n            /*return*/\n            , result];\n        }\n      });\n    });\n  };\n\n  Storage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      var deleted, models, modelIds;\n\n      var _a;\n\n      var _this = this;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.init()];\n\n          case 1:\n            _b.sent();\n\n            return [4\n            /*yield*/\n            , this.adapter.delete(modelOrModelConstructor, condition)];\n\n          case 2:\n            _a = _b.sent(), models = _a[0], deleted = _a[1];\n            modelIds = new Set(models.map(function (_a) {\n              var id = _a.id;\n              return id;\n            }));\n\n            if (!isModelConstructor(modelOrModelConstructor) && !Array.isArray(deleted)) {\n              deleted = [deleted];\n            }\n\n            deleted.forEach(function (model) {\n              var modelConstructor = Object.getPrototypeOf(model).constructor;\n              var theCondition;\n\n              if (!isModelConstructor(modelOrModelConstructor)) {\n                theCondition = modelIds.has(model.id) ? ModelPredicateCreator.getPredicates(condition, false) : undefined;\n              }\n\n              _this.pushStream.next({\n                model: modelConstructor,\n                opType: OpType.DELETE,\n                element: model,\n                mutator: mutator,\n                condition: theCondition\n              });\n            });\n            return [2\n            /*return*/\n            , [models, deleted]];\n        }\n      });\n    });\n  };\n\n  Storage.prototype.query = function (modelConstructor, predicate, pagination) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.init()];\n\n          case 1:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , this.adapter.query(modelConstructor, predicate, pagination)];\n\n          case 2:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n\n  Storage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n    if (firstOrLast === void 0) {\n      firstOrLast = QueryOne.FIRST;\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      var record;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.init()];\n\n          case 1:\n            _a.sent();\n\n            return [4\n            /*yield*/\n            , this.adapter.queryOne(modelConstructor, firstOrLast)];\n\n          case 2:\n            record = _a.sent();\n            return [2\n            /*return*/\n            , record];\n        }\n      });\n    });\n  };\n\n  Storage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n    var _a;\n\n    var listenToAll = !modelConstructor;\n    var hasPredicate = !!predicate;\n    var result = this.pushStream.observable.filter(function (_a) {\n      var mutator = _a.mutator;\n      return !skipOwn || mutator !== skipOwn;\n    }).map(function (_a) {\n      var _mutator = _a.mutator,\n          message = __rest(_a, [\"mutator\"]);\n\n      return message;\n    });\n\n    if (!listenToAll) {\n      var predicates_1, type_1;\n\n      if (hasPredicate) {\n        _a = ModelPredicateCreator.getPredicates(predicate), predicates_1 = _a.predicates, type_1 = _a.type;\n      }\n\n      result = result.filter(function (_a) {\n        var model = _a.model,\n            element = _a.element;\n\n        if (modelConstructor !== model) {\n          return false;\n        }\n\n        if (hasPredicate) {\n          return validatePredicate(element, type_1, predicates_1);\n        }\n\n        return true;\n      });\n    }\n\n    return result;\n  };\n\n  Storage.prototype.clear = function (completeObservable) {\n    if (completeObservable === void 0) {\n      completeObservable = true;\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            this.initialized = undefined;\n            return [4\n            /*yield*/\n            , this.adapter.clear()];\n\n          case 1:\n            _a.sent();\n\n            if (completeObservable) {\n              this.pushStream.complete();\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  return Storage;\n}();\n\nvar ExclusiveStorage =\n/** @class */\nfunction () {\n  function ExclusiveStorage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n    this.mutex = new Mutex();\n    this.storage = new Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter);\n  }\n\n  ExclusiveStorage.prototype.runExclusive = function (fn) {\n    return this.mutex.runExclusive(fn.bind(this, this.storage));\n  };\n\n  ExclusiveStorage.prototype.save = function (model, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.runExclusive(function (storage) {\n          return storage.save(model, condition, mutator);\n        })];\n      });\n    });\n  };\n\n  ExclusiveStorage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.runExclusive(function (storage) {\n          if (isModelConstructor(modelOrModelConstructor)) {\n            var modelConstructor = modelOrModelConstructor;\n            return storage.delete(modelConstructor, condition, mutator);\n          } else {\n            var model = modelOrModelConstructor;\n            return storage.delete(model, condition, mutator);\n          }\n        })];\n      });\n    });\n  };\n\n  ExclusiveStorage.prototype.query = function (modelConstructor, predicate, pagination) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.runExclusive(function (storage) {\n          return storage.query(modelConstructor, predicate, pagination);\n        })];\n      });\n    });\n  };\n\n  ExclusiveStorage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n    if (firstOrLast === void 0) {\n      firstOrLast = QueryOne.FIRST;\n    }\n\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , this.runExclusive(function (storage) {\n          return storage.queryOne(modelConstructor, firstOrLast);\n        })];\n      });\n    });\n  };\n\n  ExclusiveStorage.getNamespace = function () {\n    return Storage.getNamespace();\n  };\n\n  ExclusiveStorage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n    return this.storage.observe(modelConstructor, predicate, skipOwn);\n  };\n\n  ExclusiveStorage.prototype.clear = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.storage.clear()];\n\n          case 1:\n            _a.sent();\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  return ExclusiveStorage;\n}();\n\nexport default ExclusiveStorage;","map":{"version":3,"sources":["../../src/storage/storage.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nimport { Mutex } from '@aws-amplify/core';\nimport * as PushStream from 'zen-push';\nimport { ModelPredicateCreator } from '../predicates';\nimport { OpType, QueryOne, } from '../types';\nimport { isModelConstructor, STORAGE, validatePredicate } from '../util';\nimport getDefaultAdapter from './adapter/getDefaultAdapter';\nvar Storage = /** @class */ (function () {\n    function Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n        this.schema = schema;\n        this.namespaceResolver = namespaceResolver;\n        this.getModelConstructorByModelName = getModelConstructorByModelName;\n        this.modelInstanceCreator = modelInstanceCreator;\n        this.adapter = adapter;\n        this.adapter = getDefaultAdapter();\n        this.pushStream = new PushStream();\n    }\n    Storage.getNamespace = function () {\n        var namespace = {\n            name: STORAGE,\n            relationships: {},\n            enums: {},\n            models: {},\n            nonModels: {},\n        };\n        return namespace;\n    };\n    Storage.prototype.init = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var resolve, reject;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (this.initialized !== undefined) {\n                            return [2 /*return*/];\n                        }\n                        this.initialized = new Promise(function (res, rej) {\n                            resolve = res;\n                            reject = rej;\n                        });\n                        this.adapter\n                            .setUp(this.schema, this.namespaceResolver, this.modelInstanceCreator, this.getModelConstructorByModelName)\n                            .then(resolve, reject);\n                        return [4 /*yield*/, this.initialized];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Storage.prototype.save = function (model, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            var result;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.adapter.save(model, condition)];\n                    case 2:\n                        result = _a.sent();\n                        result.forEach(function (r) {\n                            var element = r[0], opType = r[1];\n                            var modelConstructor = Object.getPrototypeOf(element)\n                                .constructor;\n                            _this.pushStream.next({\n                                model: modelConstructor,\n                                opType: opType,\n                                element: element,\n                                mutator: mutator,\n                                condition: ModelPredicateCreator.getPredicates(condition, false),\n                            });\n                        });\n                        return [2 /*return*/, result];\n                }\n            });\n        });\n    };\n    Storage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            var deleted, models, modelIds;\n            var _a;\n            var _this = this;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _b.sent();\n                        return [4 /*yield*/, this.adapter.delete(modelOrModelConstructor, condition)];\n                    case 2:\n                        _a = _b.sent(), models = _a[0], deleted = _a[1];\n                        modelIds = new Set(models.map(function (_a) {\n                            var id = _a.id;\n                            return id;\n                        }));\n                        if (!isModelConstructor(modelOrModelConstructor) &&\n                            !Array.isArray(deleted)) {\n                            deleted = [deleted];\n                        }\n                        deleted.forEach(function (model) {\n                            var modelConstructor = Object.getPrototypeOf(model)\n                                .constructor;\n                            var theCondition;\n                            if (!isModelConstructor(modelOrModelConstructor)) {\n                                theCondition = modelIds.has(model.id)\n                                    ? ModelPredicateCreator.getPredicates(condition, false)\n                                    : undefined;\n                            }\n                            _this.pushStream.next({\n                                model: modelConstructor,\n                                opType: OpType.DELETE,\n                                element: model,\n                                mutator: mutator,\n                                condition: theCondition,\n                            });\n                        });\n                        return [2 /*return*/, [models, deleted]];\n                }\n            });\n        });\n    };\n    Storage.prototype.query = function (modelConstructor, predicate, pagination) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.adapter.query(modelConstructor, predicate, pagination)];\n                    case 2: return [2 /*return*/, _a.sent()];\n                }\n            });\n        });\n    };\n    Storage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n        if (firstOrLast === void 0) { firstOrLast = QueryOne.FIRST; }\n        return __awaiter(this, void 0, void 0, function () {\n            var record;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.init()];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.adapter.queryOne(modelConstructor, firstOrLast)];\n                    case 2:\n                        record = _a.sent();\n                        return [2 /*return*/, record];\n                }\n            });\n        });\n    };\n    Storage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n        var _a;\n        var listenToAll = !modelConstructor;\n        var hasPredicate = !!predicate;\n        var result = this.pushStream.observable\n            .filter(function (_a) {\n            var mutator = _a.mutator;\n            return !skipOwn || mutator !== skipOwn;\n        })\n            .map(function (_a) {\n            var _mutator = _a.mutator, message = __rest(_a, [\"mutator\"]);\n            return message;\n        });\n        if (!listenToAll) {\n            var predicates_1, type_1;\n            if (hasPredicate) {\n                (_a = ModelPredicateCreator.getPredicates(predicate), predicates_1 = _a.predicates, type_1 = _a.type);\n            }\n            result = result.filter(function (_a) {\n                var model = _a.model, element = _a.element;\n                if (modelConstructor !== model) {\n                    return false;\n                }\n                if (hasPredicate) {\n                    return validatePredicate(element, type_1, predicates_1);\n                }\n                return true;\n            });\n        }\n        return result;\n    };\n    Storage.prototype.clear = function (completeObservable) {\n        if (completeObservable === void 0) { completeObservable = true; }\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        this.initialized = undefined;\n                        return [4 /*yield*/, this.adapter.clear()];\n                    case 1:\n                        _a.sent();\n                        if (completeObservable) {\n                            this.pushStream.complete();\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return Storage;\n}());\nvar ExclusiveStorage = /** @class */ (function () {\n    function ExclusiveStorage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter) {\n        this.mutex = new Mutex();\n        this.storage = new Storage(schema, namespaceResolver, getModelConstructorByModelName, modelInstanceCreator, adapter);\n    }\n    ExclusiveStorage.prototype.runExclusive = function (fn) {\n        return this.mutex.runExclusive(fn.bind(this, this.storage));\n    };\n    ExclusiveStorage.prototype.save = function (model, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        return storage.save(model, condition, mutator);\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.prototype.delete = function (modelOrModelConstructor, condition, mutator) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        if (isModelConstructor(modelOrModelConstructor)) {\n                            var modelConstructor = modelOrModelConstructor;\n                            return storage.delete(modelConstructor, condition, mutator);\n                        }\n                        else {\n                            var model = modelOrModelConstructor;\n                            return storage.delete(model, condition, mutator);\n                        }\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.prototype.query = function (modelConstructor, predicate, pagination) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        return storage.query(modelConstructor, predicate, pagination);\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.prototype.queryOne = function (modelConstructor, firstOrLast) {\n        if (firstOrLast === void 0) { firstOrLast = QueryOne.FIRST; }\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                return [2 /*return*/, this.runExclusive(function (storage) {\n                        return storage.queryOne(modelConstructor, firstOrLast);\n                    })];\n            });\n        });\n    };\n    ExclusiveStorage.getNamespace = function () {\n        return Storage.getNamespace();\n    };\n    ExclusiveStorage.prototype.observe = function (modelConstructor, predicate, skipOwn) {\n        return this.storage.observe(modelConstructor, predicate, skipOwn);\n    };\n    ExclusiveStorage.prototype.clear = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, this.storage.clear()];\n                    case 1:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return ExclusiveStorage;\n}());\nexport default ExclusiveStorage;\n//# sourceMappingURL=storage.js.map"]},"metadata":{},"sourceType":"module"}