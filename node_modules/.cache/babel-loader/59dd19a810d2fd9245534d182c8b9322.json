{"ast":null,"code":"/*\n * Copyright 2017-2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\nvar __extends = this && this.__extends || function () {\n  var _extendStatics = function extendStatics(d, b) {\n    _extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return _extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    _extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nimport * as React from 'react';\nimport Amplify, { I18n, ConsoleLogger as Logger, Hub } from '@aws-amplify/core';\nimport Auth from '@aws-amplify/auth';\nimport Greetings from './Greetings';\nimport SignIn from './SignIn';\nimport ConfirmSignIn from './ConfirmSignIn';\nimport RequireNewPassword from './RequireNewPassword';\nimport SignUp from './SignUp';\nimport Loading from './Loading';\nimport ConfirmSignUp from './ConfirmSignUp';\nimport VerifyContact from './VerifyContact';\nimport ForgotPassword from './ForgotPassword';\nimport TOTPSetup from './TOTPSetup';\nimport Constants from './common/constants';\nimport AmplifyTheme from '../Amplify-UI/Amplify-UI-Theme';\nimport AmplifyMessageMap from '../AmplifyMessageMap';\nimport { Container, Toast } from '../Amplify-UI/Amplify-UI-Components-React';\nimport { auth } from '../Amplify-UI/data-test-attributes';\nvar logger = new Logger('Authenticator');\nvar AUTHENTICATOR_AUTHSTATE = 'amplify-authenticator-authState';\nexport var EmptyContainer = function EmptyContainer(_a) {\n  var children = _a.children;\n  return React.createElement(React.Fragment, null, children);\n};\n\nvar Authenticator =\n/** @class */\nfunction (_super) {\n  __extends(Authenticator, _super);\n\n  function Authenticator(props) {\n    var _this = _super.call(this, props) || this;\n\n    _this.handleStateChange = _this.handleStateChange.bind(_this);\n    _this.handleAuthEvent = _this.handleAuthEvent.bind(_this);\n    _this.onHubCapsule = _this.onHubCapsule.bind(_this);\n    _this._initialAuthState = _this.props.authState || 'signIn';\n    _this.state = {\n      authState: 'loading'\n    };\n    Hub.listen('auth', _this.onHubCapsule);\n    return _this;\n  }\n\n  Authenticator.prototype.componentDidMount = function () {\n    var config = this.props.amplifyConfig;\n\n    if (config) {\n      Amplify.configure(config);\n    }\n\n    this._isMounted = true; // The workaround for Cognito Hosted UI:\n    // Don't check the user immediately if redirected back from Hosted UI as\n    // it might take some time for credentials to be available, instead\n    // wait for the hub event sent from Auth module. This item in the\n    // localStorage is a mark to indicate whether the app is just redirected\n    // back from Hosted UI or not and is set in Auth:handleAuthResponse.\n\n    var byHostedUI = localStorage.getItem(Constants.REDIRECTED_FROM_HOSTED_UI);\n    localStorage.removeItem(Constants.REDIRECTED_FROM_HOSTED_UI);\n    if (byHostedUI !== 'true') this.checkUser();\n  };\n\n  Authenticator.prototype.componentWillUnmount = function () {\n    this._isMounted = false;\n  };\n\n  Authenticator.prototype.checkUser = function () {\n    var _this = this;\n\n    if (!Auth || typeof Auth.currentAuthenticatedUser !== 'function') {\n      throw new Error('No Auth module found, please ensure @aws-amplify/auth is imported');\n    }\n\n    return Auth.currentAuthenticatedUser().then(function (user) {\n      if (!_this._isMounted) {\n        return;\n      }\n\n      _this.handleStateChange('signedIn', user);\n    }).catch(function (err) {\n      if (!_this._isMounted) {\n        return;\n      }\n\n      var cachedAuthState = null;\n\n      try {\n        cachedAuthState = localStorage.getItem(AUTHENTICATOR_AUTHSTATE);\n      } catch (e) {\n        logger.debug('Failed to get the auth state from local storage', e);\n      }\n\n      var promise = cachedAuthState === 'signedIn' ? Auth.signOut() : Promise.resolve();\n      promise.then(function () {\n        return _this.handleStateChange(_this._initialAuthState);\n      }).catch(function (e) {\n        logger.debug('Failed to sign out', e);\n      });\n    });\n  };\n\n  Authenticator.prototype.onHubCapsule = function (capsule) {\n    var channel = capsule.channel,\n        payload = capsule.payload,\n        source = capsule.source;\n\n    if (channel === 'auth') {\n      switch (payload.event) {\n        case 'cognitoHostedUI':\n          this.handleStateChange('signedIn', payload.data);\n          break;\n\n        case 'cognitoHostedUI_failure':\n          this.handleStateChange('signIn', null);\n          break;\n\n        case 'parsingUrl_failure':\n          this.handleStateChange('signIn', null);\n          break;\n\n        case 'signOut':\n          this.handleStateChange('signIn', null);\n          break;\n\n        case 'customGreetingSignOut':\n          this.handleStateChange('signIn', null);\n          break;\n\n        default:\n          break;\n      }\n    }\n  };\n\n  Authenticator.prototype.handleStateChange = function (state, data) {\n    logger.debug('authenticator state change ' + state, data);\n\n    if (state === this.state.authState) {\n      return;\n    }\n\n    if (state === 'signedOut') {\n      state = 'signIn';\n    }\n\n    try {\n      localStorage.setItem(AUTHENTICATOR_AUTHSTATE, state);\n    } catch (e) {\n      logger.debug('Failed to set the auth state into local storage', e);\n    }\n\n    if (this._isMounted) {\n      this.setState({\n        authState: state,\n        authData: data,\n        error: null,\n        showToast: false\n      });\n    }\n\n    if (this.props.onStateChange) {\n      this.props.onStateChange(state, data);\n    }\n  };\n\n  Authenticator.prototype.handleAuthEvent = function (state, event, showToast) {\n    if (showToast === void 0) {\n      showToast = true;\n    }\n\n    if (event.type === 'error') {\n      var map = this.props.errorMessage || AmplifyMessageMap;\n      var message = typeof map === 'string' ? map : map(event.data);\n      this.setState({\n        error: message,\n        showToast: showToast\n      });\n    }\n  };\n\n  Authenticator.prototype.render = function () {\n    var _this = this;\n\n    var _a = this.state,\n        authState = _a.authState,\n        authData = _a.authData;\n    var theme = this.props.theme || AmplifyTheme;\n    var messageMap = this.props.errorMessage || AmplifyMessageMap; // If container prop is undefined, default to AWS Amplify UI Container\n    // otherwise if truthy, use the supplied render prop\n    // otherwise if falsey, use EmptyContainer\n\n    var Wrapper = this.props.container === undefined ? Container : this.props.container || EmptyContainer;\n    var _b = this.props,\n        hideDefault = _b.hideDefault,\n        _c = _b.hide,\n        hide = _c === void 0 ? [] : _c,\n        federated = _b.federated,\n        signUpConfig = _b.signUpConfig,\n        usernameAttributes = _b.usernameAttributes;\n\n    if (hideDefault) {\n      hide = hide.concat([Greetings, SignIn, ConfirmSignIn, RequireNewPassword, SignUp, ConfirmSignUp, VerifyContact, ForgotPassword, TOTPSetup, Loading]);\n    }\n\n    var props_children = [];\n\n    if (typeof this.props.children === 'object') {\n      if (Array.isArray(this.props.children)) {\n        props_children = this.props.children;\n      } else {\n        props_children.push(this.props.children);\n      }\n    }\n\n    var default_children = [React.createElement(Greetings, {\n      federated: federated\n    }), React.createElement(SignIn, {\n      federated: federated\n    }), React.createElement(ConfirmSignIn, null), React.createElement(RequireNewPassword, null), React.createElement(SignUp, {\n      signUpConfig: signUpConfig\n    }), React.createElement(ConfirmSignUp, null), React.createElement(VerifyContact, null), React.createElement(ForgotPassword, null), React.createElement(TOTPSetup, null), React.createElement(Loading, null)];\n    var props_children_override = React.Children.map(props_children, function (child) {\n      return child.props.override;\n    });\n    hide = hide.filter(function (component) {\n      return !props_children.find(function (child) {\n        return child.type === component;\n      });\n    });\n    var render_props_children = React.Children.map(props_children, function (child, index) {\n      return React.cloneElement(child, {\n        key: 'aws-amplify-authenticator-props-children-' + index,\n        theme: theme,\n        messageMap: messageMap,\n        authState: authState,\n        authData: authData,\n        onStateChange: _this.handleStateChange,\n        onAuthEvent: _this.handleAuthEvent,\n        hide: hide,\n        override: props_children_override,\n        usernameAttributes: usernameAttributes\n      });\n    });\n    var render_default_children = hideDefault ? [] : React.Children.map(default_children, function (child, index) {\n      return React.cloneElement(child, {\n        key: 'aws-amplify-authenticator-default-children-' + index,\n        theme: theme,\n        messageMap: messageMap,\n        authState: authState,\n        authData: authData,\n        onStateChange: _this.handleStateChange,\n        onAuthEvent: _this.handleAuthEvent,\n        hide: hide,\n        override: props_children_override,\n        usernameAttributes: usernameAttributes\n      });\n    });\n    var render_children = render_default_children.concat(render_props_children);\n    var error = this.state.error;\n    return React.createElement(Wrapper, {\n      theme: theme\n    }, this.state.showToast && React.createElement(Toast, {\n      theme: theme,\n      onClose: function onClose() {\n        return _this.setState({\n          showToast: false\n        });\n      },\n      \"data-test\": auth.signIn.signInError\n    }, I18n.get(error)), render_children);\n  };\n\n  return Authenticator;\n}(React.Component);\n\nexport default Authenticator;","map":{"version":3,"sources":["../../src/Auth/Authenticator.tsx"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/*\n * Copyright 2017-2018 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\n * the License. A copy of the License is located at\n *\n *     http://aws.amazon.com/apache2.0/\n *\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\n * and limitations under the License.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nimport * as React from 'react';\nimport Amplify, { I18n, ConsoleLogger as Logger, Hub } from '@aws-amplify/core';\nimport Auth from '@aws-amplify/auth';\nimport Greetings from './Greetings';\nimport SignIn from './SignIn';\nimport ConfirmSignIn from './ConfirmSignIn';\nimport RequireNewPassword from './RequireNewPassword';\nimport SignUp from './SignUp';\nimport Loading from './Loading';\nimport ConfirmSignUp from './ConfirmSignUp';\nimport VerifyContact from './VerifyContact';\nimport ForgotPassword from './ForgotPassword';\nimport TOTPSetup from './TOTPSetup';\nimport Constants from './common/constants';\nimport AmplifyTheme from '../Amplify-UI/Amplify-UI-Theme';\nimport AmplifyMessageMap from '../AmplifyMessageMap';\nimport { Container, Toast } from '../Amplify-UI/Amplify-UI-Components-React';\nimport { auth } from '../Amplify-UI/data-test-attributes';\nvar logger = new Logger('Authenticator');\nvar AUTHENTICATOR_AUTHSTATE = 'amplify-authenticator-authState';\nexport var EmptyContainer = function (_a) {\n    var children = _a.children;\n    return React.createElement(React.Fragment, null, children);\n};\nvar Authenticator = /** @class */ (function (_super) {\n    __extends(Authenticator, _super);\n    function Authenticator(props) {\n        var _this = _super.call(this, props) || this;\n        _this.handleStateChange = _this.handleStateChange.bind(_this);\n        _this.handleAuthEvent = _this.handleAuthEvent.bind(_this);\n        _this.onHubCapsule = _this.onHubCapsule.bind(_this);\n        _this._initialAuthState = _this.props.authState || 'signIn';\n        _this.state = { authState: 'loading' };\n        Hub.listen('auth', _this.onHubCapsule);\n        return _this;\n    }\n    Authenticator.prototype.componentDidMount = function () {\n        var config = this.props.amplifyConfig;\n        if (config) {\n            Amplify.configure(config);\n        }\n        this._isMounted = true;\n        // The workaround for Cognito Hosted UI:\n        // Don't check the user immediately if redirected back from Hosted UI as\n        // it might take some time for credentials to be available, instead\n        // wait for the hub event sent from Auth module. This item in the\n        // localStorage is a mark to indicate whether the app is just redirected\n        // back from Hosted UI or not and is set in Auth:handleAuthResponse.\n        var byHostedUI = localStorage.getItem(Constants.REDIRECTED_FROM_HOSTED_UI);\n        localStorage.removeItem(Constants.REDIRECTED_FROM_HOSTED_UI);\n        if (byHostedUI !== 'true')\n            this.checkUser();\n    };\n    Authenticator.prototype.componentWillUnmount = function () {\n        this._isMounted = false;\n    };\n    Authenticator.prototype.checkUser = function () {\n        var _this = this;\n        if (!Auth || typeof Auth.currentAuthenticatedUser !== 'function') {\n            throw new Error('No Auth module found, please ensure @aws-amplify/auth is imported');\n        }\n        return Auth.currentAuthenticatedUser()\n            .then(function (user) {\n            if (!_this._isMounted) {\n                return;\n            }\n            _this.handleStateChange('signedIn', user);\n        })\n            .catch(function (err) {\n            if (!_this._isMounted) {\n                return;\n            }\n            var cachedAuthState = null;\n            try {\n                cachedAuthState = localStorage.getItem(AUTHENTICATOR_AUTHSTATE);\n            }\n            catch (e) {\n                logger.debug('Failed to get the auth state from local storage', e);\n            }\n            var promise = cachedAuthState === 'signedIn' ? Auth.signOut() : Promise.resolve();\n            promise\n                .then(function () { return _this.handleStateChange(_this._initialAuthState); })\n                .catch(function (e) {\n                logger.debug('Failed to sign out', e);\n            });\n        });\n    };\n    Authenticator.prototype.onHubCapsule = function (capsule) {\n        var channel = capsule.channel, payload = capsule.payload, source = capsule.source;\n        if (channel === 'auth') {\n            switch (payload.event) {\n                case 'cognitoHostedUI':\n                    this.handleStateChange('signedIn', payload.data);\n                    break;\n                case 'cognitoHostedUI_failure':\n                    this.handleStateChange('signIn', null);\n                    break;\n                case 'parsingUrl_failure':\n                    this.handleStateChange('signIn', null);\n                    break;\n                case 'signOut':\n                    this.handleStateChange('signIn', null);\n                    break;\n                case 'customGreetingSignOut':\n                    this.handleStateChange('signIn', null);\n                    break;\n                default:\n                    break;\n            }\n        }\n    };\n    Authenticator.prototype.handleStateChange = function (state, data) {\n        logger.debug('authenticator state change ' + state, data);\n        if (state === this.state.authState) {\n            return;\n        }\n        if (state === 'signedOut') {\n            state = 'signIn';\n        }\n        try {\n            localStorage.setItem(AUTHENTICATOR_AUTHSTATE, state);\n        }\n        catch (e) {\n            logger.debug('Failed to set the auth state into local storage', e);\n        }\n        if (this._isMounted) {\n            this.setState({\n                authState: state,\n                authData: data,\n                error: null,\n                showToast: false,\n            });\n        }\n        if (this.props.onStateChange) {\n            this.props.onStateChange(state, data);\n        }\n    };\n    Authenticator.prototype.handleAuthEvent = function (state, event, showToast) {\n        if (showToast === void 0) { showToast = true; }\n        if (event.type === 'error') {\n            var map = this.props.errorMessage || AmplifyMessageMap;\n            var message = typeof map === 'string' ? map : map(event.data);\n            this.setState({ error: message, showToast: showToast });\n        }\n    };\n    Authenticator.prototype.render = function () {\n        var _this = this;\n        var _a = this.state, authState = _a.authState, authData = _a.authData;\n        var theme = this.props.theme || AmplifyTheme;\n        var messageMap = this.props.errorMessage || AmplifyMessageMap;\n        // If container prop is undefined, default to AWS Amplify UI Container\n        // otherwise if truthy, use the supplied render prop\n        // otherwise if falsey, use EmptyContainer\n        var Wrapper = this.props.container === undefined\n            ? Container\n            : this.props.container || EmptyContainer;\n        var _b = this.props, hideDefault = _b.hideDefault, _c = _b.hide, hide = _c === void 0 ? [] : _c, federated = _b.federated, signUpConfig = _b.signUpConfig, usernameAttributes = _b.usernameAttributes;\n        if (hideDefault) {\n            hide = hide.concat([\n                Greetings,\n                SignIn,\n                ConfirmSignIn,\n                RequireNewPassword,\n                SignUp,\n                ConfirmSignUp,\n                VerifyContact,\n                ForgotPassword,\n                TOTPSetup,\n                Loading,\n            ]);\n        }\n        var props_children = [];\n        if (typeof this.props.children === 'object') {\n            if (Array.isArray(this.props.children)) {\n                props_children = this.props.children;\n            }\n            else {\n                props_children.push(this.props.children);\n            }\n        }\n        var default_children = [\n            React.createElement(Greetings, { federated: federated }),\n            React.createElement(SignIn, { federated: federated }),\n            React.createElement(ConfirmSignIn, null),\n            React.createElement(RequireNewPassword, null),\n            React.createElement(SignUp, { signUpConfig: signUpConfig }),\n            React.createElement(ConfirmSignUp, null),\n            React.createElement(VerifyContact, null),\n            React.createElement(ForgotPassword, null),\n            React.createElement(TOTPSetup, null),\n            React.createElement(Loading, null),\n        ];\n        var props_children_override = React.Children.map(props_children, function (child) { return child.props.override; });\n        hide = hide.filter(function (component) { return !props_children.find(function (child) { return child.type === component; }); });\n        var render_props_children = React.Children.map(props_children, function (child, index) {\n            return React.cloneElement(child, {\n                key: 'aws-amplify-authenticator-props-children-' + index,\n                theme: theme,\n                messageMap: messageMap,\n                authState: authState,\n                authData: authData,\n                onStateChange: _this.handleStateChange,\n                onAuthEvent: _this.handleAuthEvent,\n                hide: hide,\n                override: props_children_override,\n                usernameAttributes: usernameAttributes,\n            });\n        });\n        var render_default_children = hideDefault\n            ? []\n            : React.Children.map(default_children, function (child, index) {\n                return React.cloneElement(child, {\n                    key: 'aws-amplify-authenticator-default-children-' + index,\n                    theme: theme,\n                    messageMap: messageMap,\n                    authState: authState,\n                    authData: authData,\n                    onStateChange: _this.handleStateChange,\n                    onAuthEvent: _this.handleAuthEvent,\n                    hide: hide,\n                    override: props_children_override,\n                    usernameAttributes: usernameAttributes,\n                });\n            });\n        var render_children = render_default_children.concat(render_props_children);\n        var error = this.state.error;\n        return (React.createElement(Wrapper, { theme: theme },\n            this.state.showToast && (React.createElement(Toast, { theme: theme, onClose: function () { return _this.setState({ showToast: false }); }, \"data-test\": auth.signIn.signInError }, I18n.get(error))),\n            render_children));\n    };\n    return Authenticator;\n}(React.Component));\nexport default Authenticator;\n//# sourceMappingURL=Authenticator.js.map"]},"metadata":{},"sourceType":"module"}