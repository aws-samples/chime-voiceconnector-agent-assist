!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@aws-amplify/core"),require("aws-sdk/clients/s3")):"function"==typeof define&&define.amd?define("aws_amplify_storage",["@aws-amplify/core","aws-sdk/clients/s3"],t):"object"==typeof exports?exports.aws_amplify_storage=t(require("@aws-amplify/core"),require("aws-sdk/clients/s3")):e.aws_amplify_storage=t(e["@aws-amplify/core"],e["aws-sdk/clients/s3"])}(this,(function(e,t){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){"use strict";r.r(t),r.d(t,"StorageClass",(function(){return v})),r.d(t,"AWSS3Provider",(function(){return p}));var n=r(0),o=r.n(n),i=r(1);function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var s=function(){return(s=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},a=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{a(n.next(e))}catch(e){i(e)}}function s(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,s)}a((n=n.apply(e,t||[])).next())}))},c=function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},l=new n.ConsoleLogger("AWSS3Provider"),f="undefined"!=typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("amplify_default"):"@@amplify_default",d=function(e,t,r,o,i){e&&n.Hub.dispatch("storage",{event:t,data:{attrs:r,metrics:o},message:i},"Storage",f)},p=function(){function e(e){this._config=e||{},l.debug("Storage Options",this._config)}return e.prototype.getCategory=function(){return e.CATEGORY},e.prototype.getProviderName=function(){return e.PROVIDER_NAME},e.prototype.configure=function(e){if(l.debug("configure Storage",e),!e)return this._config;var t=n.Parser.parseMobilehubConfig(e);return this._config=Object.assign({},this._config,t.Storage),this._config.bucket||l.debug("Do not have bucket yet"),this._config},e.prototype.get=function(e,t){return a(this,void 0,void 0,(function(){var r,n,o,i,u,s,a,f,p,g,h,y,b,v;return c(this,(function(c){switch(c.label){case 0:return[4,this._ensureCredentials()];case 1:return c.sent()?(r=Object.assign({},this._config,t),n=r.bucket,o=r.download,i=r.cacheControl,u=r.contentDisposition,s=r.contentEncoding,a=r.contentLanguage,f=r.contentType,p=r.expires,g=r.track,h=this._prefix(r),y=h+e,b=this._createS3(r),l.debug("get "+e+" from "+y),v={Bucket:n,Key:y},i&&(v.ResponseCacheControl=i),u&&(v.ResponseContentDisposition=u),s&&(v.ResponseContentEncoding=s),a&&(v.ResponseContentLanguage=a),f&&(v.ResponseContentType=f),!0===o?[2,new Promise((function(t,r){b.getObject(v,(function(n,o){n?(d(g,"download",{method:"get",result:"failed"},null,"Download failed with "+n.message),r(n)):(d(g,"download",{method:"get",result:"success"},{fileSize:Number(o.Body.length)},"Download success for "+e),t(o))}))}))]:(p&&(v.Expires=p),[2,new Promise((function(t,r){try{var n=b.getSignedUrl("getObject",v);d(g,"getSignedUrl",{method:"get",result:"success"},null,"Signed URL: "+n),t(n)}catch(t){l.warn("get signed url error",t),d(g,"getSignedUrl",{method:"get",result:"failed"},null,"Could not get a signed URL for "+e),r(t)}}))])):[2,Promise.reject("No credentials")]}}))}))},e.prototype.put=function(e,t,r){return a(this,void 0,void 0,(function(){var n,o,i,s,a,f,p,g,h,y,b,v,m,S,w,_,P,C,k,j,x,O;return c(this,(function(c){switch(c.label){case 0:return[4,this._ensureCredentials()];case 1:if(!c.sent())return[2,Promise.reject("No credentials")];n=Object.assign({},this._config,r),o=n.bucket,i=n.track,s=n.progressCallback,a=n.contentType,f=n.contentDisposition,p=n.cacheControl,g=n.expires,h=n.metadata,y=n.tagging,b=n.serverSideEncryption,v=n.SSECustomerAlgorithm,m=n.SSECustomerKey,S=n.SSECustomerKeyMD5,w=n.SSEKMSKeyId,_=a||"binary/octet-stream",P=this._prefix(n),C=P+e,k=this._createS3(n),l.debug("put "+e+" to "+C),j={Bucket:o,Key:C,Body:t,ContentType:_},p&&(j.CacheControl=p),f&&(j.ContentDisposition=f),g&&(j.Expires=g),h&&(j.Metadata=h),y&&(j.Tagging=y),b&&(j.ServerSideEncryption=b,v&&(j.SSECustomerAlgorithm=v),m&&(j.SSECustomerKey=m),S&&(j.SSECustomerKeyMD5=S),w&&(j.SSEKMSKeyId=w)),c.label=2;case 2:return c.trys.push([2,4,,5]),[4,k.upload(j).on("httpUploadProgress",(function(e){s&&("function"==typeof s?s(e):l.warn("progressCallback should be a function, not a "+u(s)))})).promise()];case 3:return x=c.sent(),l.debug("upload result",x),d(i,"upload",{method:"put",result:"success"},null,"Upload success for "+e),[2,{key:x.Key.substr(P.length)}];case 4:throw O=c.sent(),l.warn("error uploading",O),d(i,"upload",{method:"put",result:"failed"},null,"Error uploading "+e),O;case 5:return[2]}}))}))},e.prototype.remove=function(e,t){return a(this,void 0,void 0,(function(){var r,n,o,i,u,s,a;return c(this,(function(c){switch(c.label){case 0:return[4,this._ensureCredentials()];case 1:return c.sent()?(r=Object.assign({},this._config,t),n=r.bucket,o=r.track,i=this._prefix(r),u=i+e,s=this._createS3(r),l.debug("remove "+e+" from "+u),a={Bucket:n,Key:u},[2,new Promise((function(t,r){s.deleteObject(a,(function(n,i){n?(d(o,"delete",{method:"remove",result:"failed"},null,"Deletion of "+e+" failed with "+n),r(n)):(d(o,"delete",{method:"remove",result:"success"},null,"Deleted "+e+" successfully"),t(i))}))}))]):[2,Promise.reject("No credentials")]}}))}))},e.prototype.list=function(e,t){return a(this,void 0,void 0,(function(){var r,n,o,i,u,s,a,f;return c(this,(function(c){switch(c.label){case 0:return[4,this._ensureCredentials()];case 1:return c.sent()?(r=Object.assign({},this._config,t),n=r.bucket,o=r.track,i=r.maxKeys,u=this._prefix(r),s=u+e,a=this._createS3(r),l.debug("list "+e+" from "+s),f={Bucket:n,Prefix:s,MaxKeys:i},[2,new Promise((function(e,t){a.listObjects(f,(function(r,n){if(r)l.warn("list error",r),d(o,"list",{method:"list",result:"failed"},null,"Listing items failed: "+r.message),t(r);else{var i=n.Contents.map((function(e){return{key:e.Key.substr(u.length),eTag:e.ETag,lastModified:e.LastModified,size:e.Size}}));d(o,"list",{method:"list",result:"success"},null,i.length+" items returned from list operation"),l.debug("list",i),e(i)}}))}))]):[2,Promise.reject("No credentials")]}}))}))},e.prototype._ensureCredentials=function(){var e=this;return n.Credentials.get().then((function(t){if(!t)return!1;var r=n.Credentials.shear(t);return l.debug("set credentials for storage",r),e._config.credentials=r,!0})).catch((function(e){return l.warn("ensure credentials error",e),!1}))},e.prototype._prefix=function(e){var t=e.credentials,r=e.level,n=e.customPrefix||{},o=e.identityId||t.identityId,i=(void 0!==n.private?n.private:"private/")+o+"/",u=(void 0!==n.protected?n.protected:"protected/")+o+"/",s=void 0!==n.public?n.public:"public/";switch(r){case"private":return i;case"protected":return u;default:return s}},e.prototype._createS3=function(e){var t=e.bucket,r=e.region,n=e.credentials,o={};return e.dangerouslyConnectToHttpEndpointForTesting&&(o={endpoint:"http://localhost:20005",s3BucketEndpoint:!0,s3ForcePathStyle:!0}),new i(s({apiVersion:"2006-03-01",params:{Bucket:t},signatureVersion:"v4",region:r,credentials:n},o))},e.CATEGORY="Storage",e.PROVIDER_NAME="AWSS3",e}(),g=function(){return(g=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},h=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{a(n.next(e))}catch(e){i(e)}}function s(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,s)}a((n=n.apply(e,t||[])).next())}))},y=function(e,t){var r,n,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,n=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=t.call(e,u)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},b=new n.ConsoleLogger("StorageClass"),v=function(){function e(){this._config={},this._pluggables=[],b.debug("Storage Options",this._config),this.get=this.get.bind(this),this.put=this.put.bind(this),this.remove=this.remove.bind(this),this.list=this.list.bind(this)}return e.prototype.getModuleName=function(){return"Storage"},e.prototype.addPluggable=function(e){if(e&&"Storage"===e.getCategory()){this._pluggables.push(e);return e.configure(this._config[e.getProviderName()])}},e.prototype.getPluggable=function(e){var t=this._pluggables.find((function(t){return t.getProviderName()===e}));return void 0===t?(b.debug("No plugin found with providerName",e),null):t},e.prototype.removePluggable=function(e){this._pluggables=this._pluggables.filter((function(t){return t.getProviderName()!==e}))},e.prototype.configure=function(e){var t=this;if(b.debug("configure Storage"),!e)return this._config;var r=n.Parser.parseMobilehubConfig(e),o=Object.keys(r.Storage),i=["bucket","region","level","track","customPrefix","serverSideEncryption","SSECustomerAlgorithm","SSECustomerKey","SSECustomerKeyMD5","SSEKMSKeyId"],u=function(e){return i.some((function(t){return t===e}))};return o&&o.find((function(e){return u(e)}))&&!r.Storage.AWSS3&&(r.Storage.AWSS3={}),Object.entries(r.Storage).map((function(e){var t=e[0],n=e[1];t&&u(t)&&void 0!==n&&(r.Storage.AWSS3[t]=n,delete r.Storage[t])})),Object.keys(r.Storage).forEach((function(e){"string"!=typeof r.Storage[e]&&(t._config[e]=g(g({},t._config[e]),r.Storage[e]))})),this._pluggables.forEach((function(e){e.configure(t._config[e.getProviderName()])})),0===this._pluggables.length&&this.addPluggable(new p),this._config},e.prototype.get=function(e,t){return h(this,void 0,void 0,(function(){var r,n,o;return y(this,(function(i){return r=(t||{}).provider,n=void 0===r?"AWSS3":r,void 0===(o=this._pluggables.find((function(e){return e.getProviderName()===n})))&&(b.debug("No plugin found with providerName",n),Promise.reject("No plugin found in Storage for the provider")),[2,o.get(e,t)]}))}))},e.prototype.put=function(e,t,r){return h(this,void 0,void 0,(function(){var n,o,i;return y(this,(function(u){return n=(r||{}).provider,o=void 0===n?"AWSS3":n,void 0===(i=this._pluggables.find((function(e){return e.getProviderName()===o})))&&(b.debug("No plugin found with providerName",o),Promise.reject("No plugin found in Storage for the provider")),[2,i.put(e,t,r)]}))}))},e.prototype.remove=function(e,t){return h(this,void 0,void 0,(function(){var r,n,o;return y(this,(function(i){return r=(t||{}).provider,n=void 0===r?"AWSS3":r,void 0===(o=this._pluggables.find((function(e){return e.getProviderName()===n})))&&(b.debug("No plugin found with providerName",n),Promise.reject("No plugin found in Storage for the provider")),[2,o.remove(e,t)]}))}))},e.prototype.list=function(e,t){return h(this,void 0,void 0,(function(){var r,n,o;return y(this,(function(i){return r=(t||{}).provider,n=void 0===r?"AWSS3":r,void 0===(o=this._pluggables.find((function(e){return e.getProviderName()===n})))&&(b.debug("No plugin found with providerName",n),Promise.reject("No plugin found in Storage for the provider")),[2,o.list(e,t)]}))}))},e}(),m=function(){return(m=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},S=new n.ConsoleLogger("Storage"),w=null;if(!w){S.debug("Create Storage Instance"),(w=new v).vault=new v;var _=w.configure;w.configure=function(e){S.debug("storage configure called");var t=m({},_.call(w,e));Object.keys(t).forEach((function(e){"string"!=typeof t[e]&&(t[e]=m(m({},t[e]),{level:"private"}))})),S.debug("storage vault configure called"),w.vault.configure(t)}}var P=w;o.a.register(P);t.default=P}])}));
//# sourceMappingURL=aws-amplify-storage.min.js.map