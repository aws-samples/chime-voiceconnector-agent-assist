"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const execa_1 = __importDefault(require("execa"));
const path_1 = __importDefault(require("path"));
const shimPath = path_1.default.join(__dirname, '../../shim/shim.py');
async function pythonInvoke(context, request) {
    const handlerParts = path_1.default.parse(request.handler);
    const handlerFile = path_1.default.join(request.srcRoot, 'src', handlerParts.dir, handlerParts.name);
    const handlerName = handlerParts.ext.replace('.', '');
    const childProcess = execa_1.default('pipenv', ['run', 'python3', shimPath, handlerFile + '.py', handlerName]);
    childProcess.stdout.pipe(process.stdout);
    childProcess.stdin.write(JSON.stringify({ event: request.event, context: {} }) + '\n');
    const { stdout } = await childProcess;
    const lines = stdout.split('\n');
    const lastLine = lines[lines.length - 1];
    let result = lastLine;
    try {
        result = JSON.parse(lastLine);
    }
    catch (err) {
        context.print.warning('Could not parse function output as JSON. Using raw output.');
    }
    return result;
}
exports.pythonInvoke = pythonInvoke;
//# sourceMappingURL=invokeUtil.js.map